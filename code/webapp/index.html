<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Shape The Pixel</title>
  <meta name="description"
    content="A painting web app based on Cliddy, a helpful assistant in your quest to do crazy shapes and patterns!" />
  <meta name="keywords" content="pixel, draw, paint, geometry, shapes, pattern, tile, tiling, art, creativity" />
  <meta name="author" content="Hugo Daniel" />
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1" />
  <link rel="stylesheet" type="text/css" href="css/shape-the-pixel.css" />
  <script type="module">
    <deno bundle="shape_the_pixel.ts" />
  </script>
</head>

<body>
  <div id="screen" style="display: none">[
    -1.0, 1.0, 0.5,
    1.0, 1.0, 0.5,
    -1.0, -1.0, 0.5,
    -1.0, -1.0, 0.5,
    1.0, 1.0, 0.5,
    1.0, -1.0, 0.5
    ]</div>
  <div id="screenTextureCoords" style="display: none">
    [
    0.0, 1.0,
    1.0, 1.0,
    0.0, 0.0,
    0.0, 0.0,
    1.0, 1.0,
    1.0, 0.0]
  </div>
  <!-- for squares 
-->
  <div id="elements" style="display: none">
    [ 3, 2, 1, 0 ]
  </div>
  <div id="points" style="display: none">
    [
    0.0, 0.0, 0.0, 1.0,
    1.0, 0.0, 0.0, 1.0,
    1.0, 1.0, 0.0, 1.0,
    0.0, 1.0, 0.0, 1.0]
  </div>
  <shader-canvas>
    <new-modules>
      <pan-zoom-2d>
        <webgl-program-part>
          <vertex-shader>
            <code-before>
            // The values sent in this vec3 are:
            // (x, y, scale)
            uniform vec3 originAt;
            uniform mat4 panZoomMatrix;
            </code-before>
          </vertex-shader>
        </webgl-program-part>
      </pan-zoom-2d>
    </new-modules>
    <webgl-canvas>
      <webgl-vertex-array-objects>
        <quad-vao>
          <bind-buffer src="quad-vertices">
            <vertex-attrib-pointer variable="position" size="4"></vertex-attrib-pointer>
          </bind-buffer>
          <bind-buffer src="quad-indices"></bind-buffer>
          <bind-buffer src="quad-instance-scene">
            <vertex-attrib-pointer variable="instanceScene" size="3" divisor="1" type="SHORT">
            </vertex-attrib-pointer>
          </bind-buffer>
        </quad-vao>
        <screen-vao>
          <bind-buffer src="screen-vertices">
            <vertex-attrib-pointer variable="position" size="3"></vertex-attrib-pointer>
          </bind-buffer>
          <bind-buffer src="screen-texture-coords">
            <vertex-attrib-pointer variable="textureCoords" size="2">
            </vertex-attrib-pointer>
          </bind-buffer>
        </screen-vao>
      </webgl-vertex-array-objects>
      <webgl-buffers>
        <screen-vertices>
          <buffer-data src="#screen"></buffer-data>
        </screen-vertices>
        <screen-texture-coords>
          <buffer-data src="#screenTextureCoords"></buffer-data>
        </screen-texture-coords>
        <quad-vertices>
          <buffer-data src="#points"></buffer-data>
        </quad-vertices>
        <quad-indices>
          <buffer-data src="#elements" target="ELEMENT_ARRAY_BUFFER"></buffer-data>
        </quad-indices>
        <quad-instance-scene></quad-instance-scene>
        <!-- Fed by readPixels() -->
        <position-picker-pack>
          <buffer-data target="PIXEL_PACK_BUFFER" usage="STREAM_READ"></buffer-data>
        </position-picker-pack>
      </webgl-buffers>
      <webgl-textures>
        <color-texture-target>
          <tex-image-2d></tex-image-2d>
          <tex-parameter-i pname="TEXTURE_MIN_FILTER" param="NEAREST"></tex-parameter-i>
          <tex-parameter-i pname="TEXTURE_MAG_FILTER" param="NEAREST"></tex-parameter-i>
        </color-texture-target>
      </webgl-textures>
      <webgl-framebuffers>
        <elements-grid>
          <framebuffer-texture-2d attachment="COLOR_ATTACHMENT0" src="color-texture-target">
          </framebuffer-texture-2d>
          <framebuffer-renderbuffer attachment="COLOR_ATTACHMENT1">
            <renderbuffer-storage format="RG32I"></renderbuffer-storage>
          </framebuffer-renderbuffer>
          <framebuffer-renderbuffer attachment="DEPTH_ATTACHMENT">
            <renderbuffer-storage format="DEPTH_COMPONENT16"></renderbuffer-storage>
          </framebuffer-renderbuffer>
        </elements-grid>
      </webgl-framebuffers>
      <webgl-programs>
        <infinite-grid>
          <pan-zoom-2d></pan-zoom-2d>

          <vertex-shader>
            <code>
                #version 300 es

                in vec4 position;
                in ivec3 instanceScene;
                uniform mat4 projection; 
                uniform float size;

                flat out int sceneColorId;
                flat out ivec2 instancePos;
                
                vec4 squareGrid() {
                    vec4 vertex =
                        vec4(size, size, 1.0, 1.0)
                        * position
                        + vec4(vec2(instanceScene.xy) * vec2(size),
                        0.0, 0.0);

                    vec4 transformedVertex = panZoomMatrix * vertex;
                    vec4 projected = projection * transformedVertex;
                    return projected;
                }

                void main() {
                    gl_Position = squareGrid();
                    sceneColorId = instanceScene.z;
                    instancePos = instanceScene.xy;
                }
            </code>
          </vertex-shader>
          <fragment-shader>
            <code>
                #version 300 es

                precision highp float;

                uniform ivec3 hover;
                uniform float isLines;
                flat in ivec2 instancePos;
                flat in int sceneColorId;

                layout(location=0) out vec4 outColor;
                layout(location=1) out ivec2 pos;

                vec4 getColorById(int cid) {
                    vec4 color = vec4(0.0, 0.0, 0.0, 0.0);
                    if (cid == 1) {
                        color = vec4(0.75, 0.25, 0.25, 1.0);
                    } else if(cid == 2) {
                        color = vec4(0.35, 0.75, 0.25, 1.0);
                    } else if(cid == 3) {
                        color = vec4(0.35, 0.25, 0.75, 1.0);
                    } else if(cid == 4) {
                        color = vec4(0.75, 0.8, 0.25, 1.0);
                    } else if(cid == 5) {
                        color = vec4(0.1, 0.2, 0.3, 1.0);
                    }
                    return color;
                }
                void main() {
                    vec4 color = getColorById(int(sceneColorId));
                    if (hover.xy == instancePos) {
                        outColor = getColorById(hover.z);
                    } else {
                        outColor = isLines * vec4(0.2, 0.2, 0.1, 1.0)
                        + (color - isLines * color);
                    }
                    pos = instancePos;
                }
            </code>
          </fragment-shader>
          <script type="module">
          </script>
        </infinite-grid>

        <full-screen-quad>
          <vertex-shader>
            <code>
                        #version 300 es

                        in vec4 position;
                        in vec2 textureCoords;
                                                    
                        out vec2 textureUV;
                        
                        void main() {
                          gl_Position = position;
                        
                          textureUV = textureCoords;
                        }
                    </code>
          </vertex-shader>
          <fragment-shader>
            <code>
                        #version 300 es

                        precision highp float;
                        
                        in vec2 textureUV;
                        
                        uniform sampler2D screenTexture;
                        
                        out vec4 color;
                        
                        void main() {
                            color = texture(screenTexture, textureUV);
                        }
                    </code>
          </fragment-shader>
        </full-screen-quad>
      </webgl-programs>
      <draw-calls>
        <clear-color red="1" green="0" blue="0" alpha="0"></clear-color>
        <clear-flags mask="COLOR_BUFFER_BIT | DEPTH_BUFFER_BIT"></clear-flags>
      </draw-calls>
    </webgl-canvas>
  </shader-canvas>
  <main id="main">
    <p id="loading">Loading</p>
  </main>

  <template class="sections">
    <template class="app"></template>
    <template class="viewer"></template>
    <template class="projects"> </template>
    <template class="profile"> </template>
    <template class="about"> </template>
    <template class="loading">
      <p>Loading</p>
    </template>
  </template>
</body>

</html>

<!--

          <draw-loop>
          <bind-framebuffer src="elements-grid">
            <draw-buffers buffers=["COLOR_ATTACHMENT0","COLOR_ATTACHMENT1"]></draw-buffers>
            <viewport-transform x="0" y="0"></viewport-transform>
            <depth-func func="LEQUAL"></depth-func>
            <clear-flags mask="COLOR_BUFFER_BIT | DEPTH_BUFFER_BIT"></clear-flags>
            <use-program src="infinite-grid">
              <uniform-1fv var="isLines" value="0"></uniform-1fv>
              <draw-vao src="quad-vao" mode="TRIANGLE_FAN" count="4" type="UNSIGNED_SHORT">
              </draw-vao>
              <uniform-1fv var="isLines" value="1"></uniform-1fv>
              <draw-vao src="quad-vao" mode="LINE_STRIP" count="4" type="UNSIGNED_SHORT">
              </draw-vao>
            </use-program>
            <read-buffer src="COLOR_ATTACHMENT1"></read-buffer>
            <read-pixels dest="position-picker-pack" type="INT" format="RGBA_INTEGER"></read-pixels>
          </bind-framebuffer>
          <depth-func func="LEQUAL"></depth-func>
          <viewport-transform x="0" y="0"></viewport-transform>
          <use-program src="full-screen-quad">
            <active-texture var="screenTexture" src="color-texture-target"></active-texture>
            <draw-vao src="screen-vao" count="6"></draw-vao>
          </use-program>
        </draw-loop>

-->